name: Preprocessor Tests

on:
  pull_request:
    types: [assigned, opened, synchronize, reopened, ready_for_review]
    paths:
      - src/pash/preprocessor/**
      - src/pash/compiler/parser/**
      - pa.sh
  push:
    branches:
      - main
      - future
    paths:
      - src/pash/preprocessor/**
      - src/pash/compiler/parser/**
      - pa.sh

jobs:
  preprocessor-tests:
    runs-on: ubuntu-24.04
    if: github.event.pull_request.draft == false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha || github.sha }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libffi-dev pkg-config

      - name: Install PaSh dependencies
        run: |
          sudo touch /.githubenv
          sudo -E bash scripts/distro-deps.sh -o
          sudo -E bash scripts/setup-pash.sh -o

      - name: Run preprocessor tests
        run: |
          export PASH_TOP=$PWD/src/pash
          export PASH_TMP_PREFIX=$(mktemp -d)/
          export PASH_BASH_VERSION="5 2 21"
          export PYTHONPATH="$PASH_TOP/preprocessor:$PASH_TOP/compiler:$PYTHONPATH"
          source python_pkgs/bin/activate

          cd src/pash/preprocessor
          ./run_tests.sh

      - name: Verify pa.sh integration
        run: |
          export PASH_TOP=$PWD/src/pash
          export PATH=$PATH:$PWD

          # Test that preprocessing works end-to-end
          ./pa.sh -c 'echo hello'
          ./pa.sh -c 'echo hello | cat'
